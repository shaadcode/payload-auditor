import type { Access, HookOperationType, LabelFunction, StaticLabel } from 'payload'

import type { AuditorLog } from './../collections/auditor.js'
import type { Duration } from './../utils/toMS.js'

export type HookStage =
  | 'afterChange'
  | 'afterDelete'
  | 'afterError'
  | 'afterForgotPassword'
  | 'afterLogin'
  | 'afterLogout'
  | 'afterMe'
  | 'afterRead'
  | 'afterRefresh'
  | 'beforeChange'
  | 'beforeDelete'
  | 'beforeLogin'
  | 'beforeOperation'
  | 'beforeRead'
  | 'beforeValidate'
  | 'refresh'

export type AuditHookOperationType =
  | 'deleteByID'
  | 'error'
  | 'find'
  | 'findByID'
  | 'forgotPassword'
  | 'logout'
  | 'me'
  | 'refresh'
  | 'updateByID'
  | HookOperationType

export type HookOperationDebugModeConfig = {
  /**
   * üìù How to display debug logs
   *
   * üìñ long.
   *
   * üìå@type {'manual' | 'table'}
   *
   * @default "table"
   *
   * ```
   *
   * ```
   *
   * ---
   *
   * ### ‚ö†Ô∏è Critical Notes
   * - The timeStamp field is not displayed in the table type
   *
   */
  displayType?: 'manual' | 'table'
  /**
   * üìù Enable or disable debug mode
   *
   * üìñ long.
   *
   * üìå@type {'manual' | 'table'}
   *
   * @default false
   *
   * ```
   *
   * ```
   *
   * ---
   *
   * ### ‚ö†Ô∏è Critical Notes
   * - The timeStamp field is not displayed in the table type
   *
   */
  enabled?: boolean
  /**
   * üìù Select the required fields
   *
   * üìñ To reduce confusion, you can log only the fields you need.
   *
   * üìå@type {Partial<Record<keyof AuditorLog, boolean>>}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Only the true field is included in the log</caption>
   * ```ts
   * fields:{
   * type:true
   * }
   * ```
   *
   */
  fields?: Partial<Record<keyof AuditorLog, boolean>>
}

export type HookModesConfig = {
  /**
   * üìù Debug mode for better inspection of logging performance
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Enable debug mode</caption>
   * ```ts
   *    debug: {
   * enabled: boolean
   * }
   *
   * ```
   * ### ‚ö†Ô∏è Critical Notes
   * - The generated logs are only displayed in the console and are not stored in the database.
   */
  debug?: HookOperationDebugModeConfig
}

export type HookOperationConfig = {
  /**
   * üìù Specifies whether logging is enabled or disabled for this operation within the hook
   *
   * üìå@type {boolean}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Activating the create operation</caption>
   * ```ts
   *        create: {
   *             enabled: true,
   *           },
   * ```
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - If the enabled value is not entered, it is considered false.
   *
   */
  enabled?: boolean
  /**
   * üìù Auxiliary side modes
   *
   * -
   */
  modes?: HookModesConfig
}

export type HookTrackingOperationMap = {
  afterChange: {
    /**
     * Create operation
     *
     * Triggered when a new item is created.
     */
    create?: HookOperationConfig

    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig

    /**
     * Update operation
     *
     * Triggered when an existing item is updated.
     */
    update?: HookOperationConfig
  }
  afterDelete: {
    /**
     * Delete operation
     *
     * Triggered when an item is deleted.
     */
    delete?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterError: {
    /**
     * Error operation
     *
     * Triggered when an error occurs during another operation.
     */
    error?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterForgotPassword: {
    /**
     * Forgot password operation
     *
     * Triggered when a password recovery request is made.
     */
    forgotPassword?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterLogin: {
    /**
     * Login operation
     *
     * Triggered when a user logs in.
     */
    login?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterLogout: {
    /**
     * Logout operation
     *
     * Triggered when a user logs out.
     */
    logout?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterMe: {
    /**
     * Me operation
     *
     * Triggered when a user fetches their own profile information.
     */
    me?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  afterOperation: {
    countVersions?: HookOperationConfig
    /**
     * Create operation
     *
     * Triggered when a new item is created.
     */
    create?: HookOperationConfig
    /**
     * Delete operation
     *
     * Triggered when an item is deleted.
     */
    delete?: HookOperationConfig
    /**
     * Delete by ID operation
     *
     * Triggered when a specific item is deleted by its ID.
     */
    deleteByID?: HookOperationConfig
    /**
     * Find operation
     *
     * Triggered when items are queried based on specific conditions.
     */
    find?: HookOperationConfig
    /**
     * Find by ID operation
     *
     * Triggered when a specific item is retrieved by its ID.
     */
    findByID?: HookOperationConfig
    /**
     * Forgot password operation
     *
     * Triggered when a password recovery request is made.
     */
    forgotPassword?: HookOperationConfig
    /**
     * Login operation
     *
     * Triggered when a user logs in.
     */
    login?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Refresh operation
     *
     * Triggered when authentication tokens are refreshed.
     */
    refresh?: HookOperationConfig
    /**
     * Update operation
     *
     * Triggered when an existing item is updated.
     */
    update?: HookOperationConfig

    /**
     * Update by ID operation
     *
     * Triggered when a specific item is updated by its ID.
     */
    updateByID?: HookOperationConfig
  }
  afterRead: {
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Read operation
     *
     * Triggered when data is read.
     */
    read?: HookOperationConfig
  }
  afterRefresh: {
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Refresh operation
     *
     * Triggered when authentication tokens are refreshed.
     */
    refresh?: HookOperationConfig
  }
  beforeChange: {
    /**
     * Create operation
     *
     * Triggered when a new item is created.
     */
    create?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Update operation
     *
     * Triggered when an existing item is updated.
     */
    update?: HookOperationConfig
  }
  beforeDelete: {
    /**
     * Delete operation
     *
     * Triggered when an item is deleted.
     */
    delete?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  beforeLogin: {
    /**
     * Login operation
     *
     * Triggered when a user logs in.
     */
    login?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  beforeOperation: {
    /**
     * Create operation
     *
     * Triggered when a new item is created.
     */
    create?: HookOperationConfig
    /**
     * Delete operation
     *
     * Triggered when an item is deleted.
     */
    delete?: HookOperationConfig
    /**
     * Forgot password operation
     *
     * Triggered when a password recovery request is made.
     */
    forgotPassword?: HookOperationConfig
    /**
     * Login operation
     *
     * Triggered when a user logs in.
     */
    login?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Read operation
     *
     * Triggered when data is read.
     */
    read?: HookOperationConfig
    /**
     * Refresh operation
     *
     * Triggered when authentication tokens are refreshed.
     */
    refresh?: HookOperationConfig
    /**
     * Update operation
     *
     * Triggered when an existing item is updated.
     */
    update?: HookOperationConfig
  }
  beforeRead: {
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Read operation
     *
     * Triggered when data is read.
     */
    read?: HookOperationConfig
  }
  beforeValidate: {
    /**
     * Create operation
     *
     * Triggered when a new item is created.
     */
    create?: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Update operation
     *
     * Triggered when an existing item is updated.
     */
    update?: HookOperationConfig
  }
  me: {
    /**
     * Me operation
     *
     * Triggered when a user fetches their own profile information.
     */
    me: HookOperationConfig
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
  }
  refresh: {
    /**
     * üìù Auxiliary side modes
     *
     * ### ‚ö†Ô∏è Critical Notes
     * - By enabling debug mode at the hook level, all operations of that hook are logged
     */
    modes?: HookModesConfig
    /**
     * Refresh operation
     *
     * Triggered when authentication tokens are refreshed.
     */
    refresh?: HookOperationConfig
  }
}

export type TrackedCollection = {
  /**
   * üìù Globally disable tracking for this collection
   *
   * üìå@type {boolean}
   *
   * @default undefined
   *
   */
  disabled?: boolean
  /**
   * üìù Define payload cms hooks for each collection being tracked
   *
   *
   * üìå@type {Partial<HookTrackingOperationMap>}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Define an afterChange hook for a collection</caption>
   * ```ts
   * hooks: { afterChange: { create: { enabled: true } } }
   * ```
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - Each hook performs only its own operations
   * - Authentication hooks are only triggered when authentication is enabled for the collection
   *
   * Read more:
   * @see {@link https://payloadcms.com/docs/hooks/collections}
   */
  hooks?: Partial<HookTrackingOperationMap>

  /** Optional label or description for UI/doc */
  label?: string

  /**
   * üìù The original name of your collection for tracking
   *
   * üìå@type {string}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Collection tracking posts</caption>
   * ```ts
   * { slug: 'posts' },
   * ```
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - Make sure the value entered exactly matches the value in your main collection configuration.
   * @see {@link https://payloadcms.com/docs/configuration/collections#config-options}
   */
  slug: string
}

// eslint-disable-next-line @typescript-eslint/no-unused-vars
const allowedSlugs = ['activities', 'auditor', 'logger'] as const

export type BufferDebugFields = {
  flushStrategy: boolean
  interval: boolean
  size: boolean
}

export type BufferModesConfig = {
  /**
   * üìù Debug mode for better inspection of logging performance
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Enable debug mode</caption>
   * ```ts
   *    debug: {
   * enabled: boolean
   * }
   *
   * ```
   * ### ‚ö†Ô∏è Critical Notes
   * - The generated logs are only displayed in the console and are not stored in the database.
   */
  debug?: {
    /**
     * üìù How to display debug logs
     *
     * üìñ long.
     *
     * üìå@type {'manual' | 'table'}
     *
     * @default "table"
     *
     */
    displayType?: 'manual' | 'table'
    /**
     * üìù Enable or disable debug mode
     *
     * üìñ long.
     *
     * üìå@type {'manual' | 'table'}
     *
     * @default false
     *
     */
    enabled?: boolean
    /**
     * üìù Select the required fields
     *
     * üìñ To reduce confusion, you can log only the fields you need.
     *
     * üìå@type {BufferDebugFields}
     *
     * @default undefined
     *
     *
     * üì¶ Usage Example
     *
     * @example <caption>üß™ Only the size field is included in the log</caption>
     * ```ts
     * fields:{
     * size: true
     * }
     * ```
     */
    fields?: Partial<BufferDebugFields>
  }
}

export type BufferConfig = {
  /**
   * üìù The basics of injecting logs into the database
   *
   *
   *
   * @default "time"
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Data injection based on log count</caption>
   * ```ts
   *  flushStrategy: 'size',
   * ```
   * ### ‚ö†Ô∏è Critical Notes
   * - If you use the size method, your logs will be stored in RAM before being injected into the database.
   *
   */
  flushStrategy?: 'realtime' | 'size' | 'time'
  /**
   * üìù Auxiliary side modes
   */
  modes?: BufferModesConfig
  /**
   * üìù Maximum number of logs before injection
   *
   * üìñ If the number of logs stored in the buffer memory reaches this number, data will be injected.
   *
   * üìå@type {number}
   *
   * @default 10
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Up to 18 logs can be stored in memory</caption>
   * ```ts
   *  size: 18
   * ```
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - Works when flushStrategy is equal to size
   * - If you enter the number 1, use the realtime method and do not define a value for this.
   * ```ts
   *  flushStrategy: 'realtime',
   * ```
   * - Very high numbers will increase RAM usage.
   * - If you set a high number and on the other hand the logs produced are low, the logs will be recorded later.
   *
   */
  size?: number

  /**
   * üìù Maximum time to inject logs into the buffer relative to the last injection
   *
   *
   * üìå@type {Duration}
   *
   * @default "5s"
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Inject logs every 1 minute</caption>
   * ```ts
   *  time: "1m"
   * ```
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - If you want to enter a value of "1s", set the flushStrategy value to time instead and do not define a value for the time property.
   * ```ts
   *  flushStrategy: 'realtime',
   * ```
   * - If you set the time too low, the CPU will be severely affected.
   * - If you allow too much time, the logs will be recorded later. If the server crashes, the logs will be lost.
   */
  time?: Duration
}
export type CollectionConfig = {
  /**
   * üìù auditor Collection Accessibility Settings
   *
   * üìñ Determine who can access the collection for what purposes. You can even fully customize each operation.
   *
   *
   * @default undefined
   *
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - If you do not define a value, the default access rule is used, which is as follows:
   * ```({ req }) => req.user?.role === 'admin'```
   * - Currently only read operations are available
   */
  Accessibility?: {
    /**
     * üìù Full accessibility customization for collections in every operation
     *
     *
     * @default undefined
     *
     *
     * üì¶ Usage Example
     *
     * @example <caption>üß™ Allow only specific users to read.</caption>
     * ```ts
     * customAccess: {
     *   read: ({ req }) => req.user?.email === 'admin@example.com',
     * }
     * ```
     *
     * ---
     * ### ‚ö†Ô∏è Critical Notes
     * - For any operation (such as reading), it works when you have not defined any custom roles in roles for that operation.
     *
     */
    customAccess?: {
      read?: Access
    }
    /**
     * üìù Define which roles are allowed for each operation.
     *
     *
     *
     * @default undefined
     *
     *
     * üì¶ Usage Example
     *
     * @example <caption>üß™ Only super-admin and CEO roles can view (read) logs</caption>
     * ```ts
     * roles: {
     *    read: ['CEO', 'super-admin'],
     *  },
     * ```
     *
     * ---
     * ### ‚ö†Ô∏è Critical Notes
     * - When you have defined specific roles for an operation, customAccess values for that operation are ignored.
     *
     */
    roles?: {
      read: string[]
    }
  }
  /**
   * üìù Buffer management for injecting data into the database
   *
   *
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Data Injection into Database Based on Time</caption>
   * ```ts
   *  buffer: {
   *       flushStrategy: 'time',
   *     }
   * ```
   *
   * ---
   * ## ‚ö†Ô∏è Critical Notes
   * - These settings are very important, to change these settings, consider all aspects including RAM and server power.
   *
   */
  buffer?: BufferConfig

  /**
   * üìù Uses internal payload CMS configuration for labels
   *
   * üìñ You can customize the plugin's built-in collection label.
   * @see {@link https://payloadcms.com/docs/configuration/collections#config-options}
   */
  labels?:
    | {
        plural?: LabelFunction | StaticLabel | undefined
        singular?: LabelFunction | StaticLabel
      }
    | undefined
  /**
   * üìù Uses internal payload CMS configuration for slug
   *
   * üìñ You can customize the plugin's built-in collection slug.
   *
   * @see {@link https://payloadcms.com/docs/configuration/collections#config-options}
   */
  slug?: (typeof allowedSlugs)[number] | ({} & string)

  /**
   * üìù Collection tracking management
   *
   * üìñ You should define the collections you want to track in this section.
   *  You can specify which hook each collection should use and what operations (within each hook) should generate logs.
   *
   * üìå@type {TrackedCollection[]}
   *
   * @default []
   *
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Track post collections when a new post is created</caption>
   * ```ts
   * trackCollections: [
   *       { slug: 'posts', hooks: { afterChange: { create: { enabled: true } } } },
   *     ],
   * ```
   * @example <caption>üß™ Temporarily disable tracking for a collection</caption>
   * ```ts
   * trackCollections: [
   *  { slug: 'slug', disabled: true, hooks: { afterChange: { create: { enabled: true } } } },
   * ],
   * ```
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * - To temporarily disable tracking for any collection, you can use the disabled key.
   *
   */
  trackCollections: TrackedCollection[]
}

// export type CountStrategy = {
//   amountToDelete: number
//   deletionCount: number
//   name: 'count'
// }

// export type TimeStrategy = {
//   name: 'time'
//   olderThan: Duration
// }

export type ManualStrategy = {
  name: 'manual'
  olderThan: Duration
}
export type AutomationConfig = {
  logCleanup: {
    // disabled?: boolean
    // schedule?: CronConfig
    strategy?: ManualStrategy
    // CountStrategy
    //  | TimeStrategy
    // taskConfig?: TaskConfig<DeleteOldLogResultTask>
    // withJobs?: boolean
  }
}

export type PluginOptions = {
  // /**
  //  * üìù Defines the interval for automatic deletion of logs or data.
  //  *
  //  * üìñ This interval is specified as a string containing a number followed by a time unit.
  //  *
  //  * üìå@type {Duration}
  //  *
  //  * @default "1mo"
  //  *
  //  * Supported time units include:
  //  * - 'd' for days
  //  * - 'h' for hours
  //  * - 'm' for minutes
  //  * - 'mo' for months
  //  * - 's' for seconds
  //  * - 'w' for weeks
  //  * - 'y' for years
  //  *
  //  * ---
  //  * üì¶ Usage Example
  //  *
  //  * @example <caption>üß™ For 7 days</caption>
  //  * ```
  //  * autoDeleteInterval?: "7d",
  //  * ```
  //  *
  //  * @example <caption>üß™ For 2 weeks</caption>
  //  * ```
  //  * autoDeleteInterval?: "2w",
  //  * ```
  //  *
  //  * ---
  //  * üí° Tips:
  //  * - Use small durations for testing (e.g., `'5s'`)
  //  * - For production, prefer longer intervals (e.g., `'1w'`, `'1mo'`)
  //  *
  //  * ‚ö†Ô∏è Keep in mind:
  //  * - Values below `'1s'` may be invalid.
  //  * - Only use supported suffixes: `s`, `m`, `h`, `d`, `w`, `mo`, `y`
  //  *
  //  */
  // autoDeleteInterval?: Duration
  /**
   * üìù Automatic plugin process management
   *
   *
   * üìå@type {AutomationConfig}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Setting a strategy for the log cleaner</caption>
   * ```
   *
   *   automation:{
   *     logCleanup: {
   *       strategy: "time"
   *     }
   *   }
   *
   *```
   * ---
   * ### ‚ö†Ô∏è Critical Notes
   * -
   *
   */
  automation?: AutomationConfig

  /**
   * üìù Settings related to collections and the collection used by the plugin
   *
   * üìå@type {CollectionConfig}
   *
   * @default undefined
   *
   *
   * üì¶ Usage Example
   *
   * @example <caption>üß™ Media collection tracking</caption>
   * ```ts
   * trackCollections: [
   *   { slug: 'media', hooks: { afterChange: { update: { enabled: true } } } },
   * ],
   * ```
   *
   * ---
   * #### ‚ö†Ô∏è Critical Notes
   * - If defined, you must also enter the value of trackCollections.
   *
   */
  collection?: CollectionConfig
  /**
   * üìù Enable or disable the plugin
   *
   * üìå@type {boolean}
   *
   * @default "true"
   */
  enabled?: boolean
}
